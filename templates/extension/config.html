<!-- templates/index.html -->
{% extends 'extension/base.html' %}

{% block content %}

    {{ content|safe }}

    <div id="responseMessage"></div> <!-- Container f端r die Erfolgsanzeige -->

    <div id="userTableContainer"></div> <!-- Container f端r die Tabelle -->


    <script type="text/javascript">

        window.onload = function() {
            if (window.location.hash) {
                // Hash-Parameter extrahieren
                const hash = window.location.hash.substring(1);
                const params = JSON.parse(decodeURIComponent(hash));
                const configurationToken = params.partnerConfigurationToken;

                // Token an Ihr Backend senden (Beispielcode)
                fetch('/extension/fetchconfig', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ configurationToken: configurationToken })
                })
                .then(response => response.json())
                .then(config => {
                    // Hier w端rden Sie Ihre Konfigurationsformular bef端llen
                    console.log('Konfiguration geladen:', config);
                    // Beispiel: document.getElementById('taskList').innerHTML = config.tasks.join(', ');
                })
                .catch(error => {
                    console.error('Fehler beim Laden der Konfiguration:', error);
                });
            }
        };

    </script>

    <script>

        // Add an event listener to receive events from Chaster
        addEventListener("message", async (e) => {
        if (typeof e.data !== "string") return

        const { type, event } = JSON.parse(e.data)

        if (type === "chaster" && event === "partner_configuration_save") {
            // Show a spinner loader on the modal
            window.parent.postMessage(
            JSON.stringify({ type: "partner_configuration", event: "save_loading" }),
            "*"
            )

            // Send the configuration to your backend to save it
            await fetch(`/lock-opener/configuration/${configurationToken}`, {
            method: "PUT",
            body: configuration,
            })

            // Close the modal
            window.parent.postMessage(
            JSON.stringify({ type: "partner_configuration", event: "save_success" }),
            "*"
            )
        }
        })

    </script>
    
    
    


{% endblock %}
